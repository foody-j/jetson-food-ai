# 바켓 감지 문제 해결 보고서

## 문제 상황

JETSON2_INTEGRATED.py에서 바켓(bucket) 감지가 작동하지 않는 문제 발생

### 증상
- 바켓 감지 AI를 시작해도 "Basket Not Found" 메시지만 표시됨
- 화면에 바켓이 있어도 감지되지 않음
- 윈도우에서 학습시킨 `besta.pt` 모델을 사용했으나 작동 안 함

## 원인 분석

### 1. 모델 파일 확인
```bash
# 모델 파일 위치 확인
/home/dkuyj/jetson-camera-monitor/observe_add/besta.pt
/home/dkuyj/jetson-camera-monitor/observe_add/bestb.pt
```

### 2. 모델 클래스 분석
```python
# 실제 모델 내용 확인
besta.pt 클래스: {0: 'empty', 1: 'filled'}  # Classification 모델
bestb.pt 클래스: {0: 'basket'}              # Segmentation 모델
```

### 3. 설정 파일의 문제점

**수정 전 (config_jetson2.json - 잘못된 매핑):**
```json
{
  "observe_seg_model": "../observe_add/besta.pt",  // {0: 'empty', 1: 'filled'}
  "observe_cls_model": "../observe_add/bestb.pt"   // {0: 'basket'}
}
```

**코드에서 기대하는 동작 (JETSON2_INTEGRATED.py:935):**
```python
if r.names[cls_idx] == "basket":  # Segmentation 모델에서 "basket" 클래스를 찾음
```

**실제 상황:**
- Segmentation 모델(besta.pt)은 `{0: 'empty', 1: 'filled'}` 클래스만 가짐
- "basket" 클래스가 없어서 바켓을 감지할 수 없었음

## 해결 방법

### 모델 경로 교체

**config_jetson2.json 수정:**
```json
{
  "observe_seg_model": "../observe_add/bestb.pt",  // {0: 'basket'} ✓
  "observe_cls_model": "../observe_add/besta.pt"   // {0: 'empty', 1: 'filled'} ✓
}
```

### 수정 후 동작 흐름

1. **Segmentation 단계 (bestb.pt)**
   - 화면에서 "basket" 객체를 세그멘테이션으로 찾음
   - 바켓의 마스크와 바운딩 박스를 생성

2. **Classification 단계 (besta.pt)**
   - 감지된 바켓 영역(ROI)을 잘라냄
   - "empty" 또는 "filled" 상태로 분류

3. **Majority Voting**
   - 7프레임(VOTE_N=7) 동안의 결과로 안정적인 상태 판단
   - 과반수 이상이면 "FILLED", 아니면 "EMPTY"로 최종 결정

## 검증 결과

```python
=== 수정 후 ===
Segmentation 모델 (bestb.pt) 클래스: {0: 'basket'}
Classification 모델 (besta.pt) 클래스: {0: 'empty', 1: 'filled'}

✓ Segmentation 모델이 "basket" 클래스를 정상적으로 가지고 있음
```

## 재발 방지

### 모델 파일 명명 규칙 개선 제안
현재 `besta.pt`, `bestb.pt` 같은 이름은 용도 파악이 어려움

**권장 명명 규칙:**
```
basket_seg.pt   # 바켓 segmentation 모델
basket_cls.pt   # 바켓 classification 모델
```

또는

```
observe_seg_basket.pt      # 바켓 감지용 segmentation
observe_cls_filled.pt      # 바켓 상태 분류용 classification
```

## 수정 파일

- `/home/dkuyj/jetson-camera-monitor/jetson2_frying_ai/config_jetson2.json`

## 적용 방법

1. Jetson2 프로그램 재시작
2. "바켓 감지 시작" 버튼 클릭
3. 바켓이 화면에 나타나면 정상적으로 감지되는지 확인

## 날짜

2025-11-06

---

## 참고: AI 처리 파이프라인

```
카메라 프레임 입력
    ↓
[Segmentation 모델 - bestb.pt]
    ↓ "basket" 클래스 감지
바켓 영역 추출 (ROI)
    ↓
[Classification 모델 - besta.pt]
    ↓ "empty" vs "filled" 분류
Majority Voting (7프레임)
    ↓
최종 상태 결정: FILLED / EMPTY / NO_BASKET
    ↓
MQTT 전송 + GUI 업데이트
```
