# 🚀 Jetson 음식 AI 시스템 배포 가이드

**이 문서 하나만 읽으면 배포 완료!**

**최종 업데이트:** 2025-11-10
**대상:** JetPack 6.2 (L4T R36.4.3)

---

## 📋 준비물

### 필수
- ✅ Jetson Orin Nano (JetPack 6.2 설치됨)
- ✅ GMSL 카메라 3대 (Jetson #1) 또는 4대 (Jetson #2)
- ✅ 모니터 + 키보드/마우스
- ✅ WiFi 연결 (Python 패키지 설치에만 필요, 약 10분)
- ✅ 로봇 PC (MQTT Broker 실행)

### 선택
- USB 드라이브 (프로젝트 파일 전송용)

---

## ⏱️ 소요 시간

- **전체 설치**: 약 35~45분
  - pip3 설치: 2분
  - Python 패키지 설치: 10분
  - GMSL 드라이버 설치: 5분
  - 자동 실행 설정: 5분
  - MQTT 설정: 5분
  - 테스트: 10분

---

## 🔄 업데이트 배포 (기존 시스템)

**이미 설치된 시스템에 코드 업데이트만 하는 경우**

### ⚠️ 주의: 절대 하지 말아야 할 것

#### ❌ 폴더 전체 삭제 금지!
```bash
# 이런 명령 절대 실행 금지!!!
rm -rf ~/jetson-food-ai  # ← 절대 실행하지 마세요!
```

**왜 안 되나요?**
1. **Python 패키지는 폴더에 없음** - 시스템 전역에 설치됨 (`~/.local/lib/python3.10/site-packages/`)
2. **서비스 파일은 다른 위치** - `/etc/systemd/system/`에 등록됨
3. **폴더 삭제해도 패키지/서비스 복구 안 됨** - 단순히 코드 파일만 사라짐
4. **설정 파일과 데이터 손실** - config.json, 수집된 데이터 날아감

**폴더 삭제 시 생기는 문제**:
- ✅ 코드는 USB에서 복원 가능
- ❌ Python 패키지 경로 연결이 깨질 수 있음
- ❌ 서비스 파일이 존재하는 경로를 찾지 못함
- ❌ 수집된 데이터 영구 손실 (백업 없으면)

---

### ✅ 올바른 업데이트 절차

#### 1단계: 서비스 중지
```bash
# Jetson1
sudo systemctl stop jetson1-monitor.service

# Jetson2
sudo systemctl stop jetson2-monitor.service
```

**서비스 이름 확인 (혹시 다른 이름이면)**:
```bash
sudo systemctl list-units | grep jetson
```

---

#### 2단계: Python 캐시 삭제 (중요!)
```bash
# Jetson1
rm -rf ~/jetson-food-ai/jetson1_monitoring/__pycache__
rm -f ~/jetson-food-ai/jetson1_monitoring/*.pyc

# Jetson2
rm -rf ~/jetson-food-ai/jetson2_frying_ai/__pycache__
rm -f ~/jetson-food-ai/jetson2_frying_ai/*.pyc
```

**이유**: Python이 이전 버전의 컴파일된 코드(.pyc)를 사용하는 것을 방지

---

#### 3단계: 파일 덮어쓰기

**방법 A: USB에서 수동 복사 (추천)**

1. USB 연결
2. 파일 탐색기 열기
3. USB의 `jetson-food-ai` 폴더 열기
4. 변경된 파일 선택 (또는 전체 선택 Ctrl+A)
5. 복사 (Ctrl+C)
6. 기존 `~/jetson-food-ai` 폴더로 이동
7. 붙여넣기 (Ctrl+V)
8. **"덮어쓰기"** 또는 **"모두 바꾸기"** 선택 ✅

**방법 B: 명령어로 복사**
```bash
# USB 경로 확인
ls /media/$USER/

# USB 이름 확인 후 복사 (예: USB_NAME을 실제 이름으로 변경)
USB_PATH="/media/$USER/USB_NAME/jetson-food-ai"

# Jetson1 파일 복사
cp $USB_PATH/jetson1_monitoring/*.py ~/jetson-food-ai/jetson1_monitoring/
cp $USB_PATH/jetson1_monitoring/config.json ~/jetson-food-ai/jetson1_monitoring/

# Jetson2 파일 복사
cp $USB_PATH/jetson2_frying_ai/*.py ~/jetson-food-ai/jetson2_frying_ai/
cp $USB_PATH/jetson2_frying_ai/config_jetson2.json ~/jetson-food-ai/jetson2_frying_ai/

# 테스트 스크립트 및 문서
cp $USB_PATH/test_mqtt_publish.py ~/jetson-food-ai/
cp $USB_PATH/MQTT_메시지_타입_정리.md ~/jetson-food-ai/
```

---

#### 4단계: 필수 서비스 확인

**MQTT Broker 확인**:
```bash
sudo systemctl status mosquitto
```

**실행 중이 아니면**:
```bash
sudo systemctl start mosquitto
sudo systemctl enable mosquitto  # 부팅 시 자동 시작
```

**Python 패키지 확인** (에러 발생 시만):
```bash
# Jetson2 필수 패키지 확인
python3 -c "import ultralytics; print('ultralytics OK')"
python3 -c "import cv2; print('opencv OK')"
python3 -c "import paho.mqtt.client; print('paho-mqtt OK')"
```

**에러 나면 설치**:
```bash
pip3 install ultralytics opencv-python paho-mqtt
```

---

#### 5단계: 서비스 재시작
```bash
# 캐시 삭제 한 번 더 (확실하게)
rm -rf ~/jetson-food-ai/*/__pycache__

# Jetson1
sudo systemctl start jetson1-monitor.service

# Jetson2
sudo systemctl start jetson2-monitor.service
```

---

#### 6단계: 상태 확인 및 로그 모니터링
```bash
# 상태 확인
sudo systemctl status jetson2-monitor.service

# 실시간 로그 확인 (가장 중요!)
sudo journalctl -u jetson2-monitor.service -f
```

**정상 동작 확인 사항**:
- ✅ `Active: active (running)` 표시
- ✅ 에러 메시지 없음
- ✅ `[카메라] 초기화 완료` 같은 로그 출력
- ✅ `[MQTT] 연결 성공` 메시지
- ✅ GUI 창이 정상적으로 표시됨

---

### 🔧 업데이트 후 문제 해결

#### 문제 1: `ModuleNotFoundError: No module named 'ultralytics'`

**원인**:
- 서비스가 root 권한으로 실행되어 일반 유저가 설치한 패키지를 못 찾음
- 또는 실제로 패키지가 설치 안 되어 있음

**확인**:
```bash
# 1. 패키지 설치 확인
pip3 list | grep ultralytics

# 2. 서비스 User 확인
sudo cat /etc/systemd/system/jetson2-monitor.service | grep "User="
# User=hr_dku_002 (일반 유저여야 함, root이면 안 됨)

# 3. PYTHONPATH 확인
sudo cat /etc/systemd/system/jetson2-monitor.service | grep "PYTHONPATH"
# Environment="PYTHONPATH=/home/hr_dku_002/.local/lib/python3.10/site-packages"
```

**해결**:
```bash
# 패키지 설치 (없는 경우)
pip3 install ultralytics

# 서비스 설정 문제 (User가 root이거나 없는 경우)
cd ~/jetson-food-ai
sudo ./uninstall_autostart.sh
sudo ./install_autostart.sh  # 다시 설치 (일반 유저 권한으로)

# 재시작
sudo systemctl daemon-reload
sudo systemctl restart jetson2-monitor.service
```

---

#### 문제 2: `[Errno 111] Connection refused` (MQTT)

**원인**: mosquitto 서비스가 실행되지 않음

**해결**:
```bash
sudo systemctl start mosquitto
sudo systemctl enable mosquitto
sudo systemctl status mosquitto
```

**MQTT 포트 확인**:
```bash
sudo netstat -tulpn | grep 1883
```

---

#### 문제 3: 서비스가 계속 재시작됨 (restart loop)

**증상**:
```
Active: activating (auto-restart)
Main process exited, code=exited, status=1/FAILURE
```

**확인 순서**:
```bash
# 1. 로그 확인 (가장 중요!)
sudo journalctl -u jetson2-monitor.service -n 50 --no-pager

# 2. 수동 실행으로 에러 확인
cd ~/jetson-food-ai/jetson2_frying_ai
python3 JETSON2_INTEGRATED.py
# 어떤 에러가 나는지 직접 확인

# 3. 카메라 초기화 확인
ls -l /dev/video*
# video0~3 있어야 함

# 4. 카메라 재초기화 (필요시)
sudo ~/jetson-food-ai/init_gmsl_cameras.sh
```

---

#### 문제 4: 폴더를 이미 삭제해버린 경우

**복구 절차**:
```bash
# 1. USB에서 다시 복사
cd ~
cp /media/$USER/USB_NAME/jetson-food-ai.tar.gz ~/
tar -xzf jetson-food-ai.tar.gz

# 2. 서비스는 그대로 있을 것 (확인)
sudo systemctl list-units | grep jetson

# 3. 서비스 재시작
sudo systemctl restart jetson1-monitor.service
sudo systemctl restart jetson2-monitor.service

# 4. 패키지 누락 확인 (에러 나면 설치)
python3 -c "import ultralytics, cv2, paho.mqtt.client"
# 에러 나면: pip3 install ultralytics opencv-python paho-mqtt
```

---

### 📋 업데이트 체크리스트

**업데이트 전**:
- [ ] 백업 (선택): `cp -r ~/jetson-food-ai ~/jetson-food-ai.backup.$(date +%Y%m%d)`
- [ ] MQTT Broker 실행 중 확인
- [ ] 서비스 중지
- [ ] 캐시 삭제

**업데이트**:
- [ ] 파일 **덮어쓰기** (삭제 X)
- [ ] config.json 설정 유지 확인 (MQTT IP 등)

**업데이트 후**:
- [ ] 서비스 재시작
- [ ] 로그 확인 (에러 없는지)
- [ ] MQTT 연결 확인
- [ ] 카메라 정상 작동 확인
- [ ] GUI 창 표시 확인

---

### 💡 업데이트 팁

**빠른 재시작**:
```bash
# 두 서비스 동시 재시작
sudo systemctl restart jetson1-monitor.service jetson2-monitor.service && \
sudo journalctl -u jetson2-monitor.service -f
```

**로그 저장** (문제 발생 시 기록용):
```bash
sudo journalctl -u jetson2-monitor.service -n 200 > ~/debug_$(date +%Y%m%d_%H%M%S).log
```

**config.json 백업**:
```bash
cp ~/jetson-food-ai/jetson2_frying_ai/config_jetson2.json ~/config_backup.json
```

---

## 🌐 초기 배포 방법 (새 시스템)

### ✅ USB로 파일 전송 (추천)

**개발 PC에서:**

```bash
cd /home/yjk
tar -czf jetson-food-ai.tar.gz \
    --exclude='__pycache__' \
    --exclude='.git' \
    --exclude='Detection/*' \
    --exclude='StirFry_Data/*' \
    --exclude='AI_Data/*' \
    jetson-food-ai

# USB로 복사
cp jetson-food-ai.tar.gz /media/usb/
```

**타겟 Jetson에서:**

```bash
# USB에서 복사
cp /media/usb/jetson-food-ai.tar.gz ~/
tar -xzf jetson-food-ai.tar.gz
cd jetson-food-ai
```

---

## 🔧 설치 과정 (단계별)

### 0-1단계: 팝업 비활성화 (1분) ⚠️ **필수**

**현장 배포 시 System Program Problem 팝업, 업데이트 알림 등을 제거합니다:**

```bash
cd ~/jetson-food-ai
./disable_popups.sh
```

**스크립트 실행 내용:**
- System Program Problem Detected 팝업 제거
- 업데이트 알림 팝업 제거
- 자동 업데이트 체크 비활성화

**재부팅 필요:**
```bash
sudo reboot
```

---

### 0-2단계: 자동 로그인 설정 (2분) ⚠️ **필수**

재부팅 시 자동으로 프로그램이 실행되려면 자동 로그인이 필수입니다.

```bash
# 자동 로그인 설정
sudo nano /etc/gdm3/custom.conf
```

**수정:**
```ini
[daemon]
# 아래 두 줄의 주석(#)을 제거하고 사용자 이름 입력
AutomaticLoginEnable = true
AutomaticLogin = hr_dku_002    # 실제 사용자 이름으로 변경
```

**저장:** `Ctrl+O` → `Enter` → `Ctrl+X`

**재부팅 후 자동 로그인 확인:**
```bash
sudo reboot
```

---

### 1단계: 한글 폰트 설치 (5분)

```bash
cd ~/jetson-food-ai
sudo ./install_korean_fonts.sh
```

---

### 2단계: CH340 USB-Serial 드라이버 설치 (3분) - **WiFi 필요** 📡

**USB-RS485 통신이 필요한 경우 (선택사항):**

```bash
cd ~/jetson-food-ai
sudo bash setup_ch340_complete.sh
```

**실행 내용:**
- CH341 커널 모듈 빌드 및 설치
- brltty 충돌 해결 (자동 제거)
- udev 규칙 설정 (/dev/ttyUSB_CH340)
- 재부팅 시 자동 로드 설정

**확인:**
```bash
# USB-RS485 변환기 연결 후
ls -l /dev/ttyUSB*
# 출력: /dev/ttyUSB0, /dev/ttyUSB_CH340
```

**참고:** GMSL 카메라만 사용하는 경우 이 단계는 건너뛰어도 됩니다.

---

### 3단계: pip3 설치 (2분) - **WiFi 필요** 📡

**JetPack 기본 이미지에는 pip3가 없습니다:**

```bash
# apt 업데이트 및 pip3 설치
sudo apt update
sudo apt install -y python3-pip

# 설치 확인
pip3 --version
# 출력: pip 20.x.x from ...
```

---

### 4단계: Python 패키지 설치 (10분) - **WiFi 필요** 📡

**Jetson1용:**
```bash
pip3 install -r jetson1_monitoring/requirements.txt
```

**Jetson2용:**
```bash
pip3 install -r jetson2_frying_ai/requirements.txt
```

**NumPy 버전 확인 및 다운그레이드 (중요!):**
```bash
# NumPy 2.x가 설치되어 있으면 호환성 문제 발생
# --force-reinstall로 강제 재설치
pip3 install 'numpy>=1.21.0,<2.0.0' --force-reinstall

# 확인
python3 -c "import numpy; print(f'NumPy: {numpy.__version__}')"
# 출력: NumPy: 1.26.x (1.x 버전이어야 함)
```

**PyTorch + torchvision CUDA 버전 (필수):**

⚠️ **중요: 기존 torch가 있으면 완전히 제거 후 설치:**
```bash
# 기존 torch 제거 (있다면)
pip3 uninstall -y torch torchvision

# Jetson용 CUDA 버전 설치
pip3 install torch torchvision --index-url https://pypi.jetson-ai-lab.io/jp6/cu126

# 설치 확인
python3 -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA Available: {torch.cuda.is_available()}')"
```

**정상 출력:**
```
PyTorch: 2.9.0
CUDA Available: True ✓
```

**만약 False가 나온다면:**
```bash
# 완전히 제거
pip3 uninstall -y torch torchvision
rm -rf ~/.local/lib/python3.10/site-packages/torch*

# 재설치
pip3 install torch torchvision --index-url https://pypi.jetson-ai-lab.io/jp6/cu126
```

---

### 5단계: MAXN 성능 모드 설정 (5분)

```bash
cd ~/jetson-food-ai

# MAXN 모드 활성화
sudo ./set_maxn_mode.sh

# 부팅 시 자동 적용 (권장)
sudo ./install_maxn_service.sh

# 확인
sudo nvpmodel -q
# 출력: NV Power Mode: MAXN_SUPER
```

---

### 6단계: GPIO 설정 (Jetson1만 해당, 5분) 🚨

**Jetson1에서 SSR(히터/장비) 제어를 위한 GPIO Pin 7 활성화:**

#### 6-1. Device Tree Overlay 설정

```bash
cd ~/jetson-food-ai/jetson-orin-gpio-patch

# DTS 파일 컴파일 (이미 컴파일된 .dtbo가 있으면 스킵 가능)
dtc -O dtb -o pin7_as_gpio.dtbo pin7_as_gpio.dts

# overlay 파일을 /boot에 복사
sudo cp pin7_as_gpio.dtbo /boot/

# jetson-io로 overlay 활성화
sudo /opt/nvidia/jetson-io/jetson-io.py
```

**메뉴 선택:**
1. `Configure Jetson 40pin Header`
2. `Pin 7 gpio bidirectional` 찾아서 활성화 (스페이스바)
3. `Save and reboot` (재부팅됨)

**재부팅 후 확인:**
```bash
# GPIO 테스트
cd ~/jetson-food-ai
python3 gpio_test.py
# 멀티미터로 Pin 7에서 3.3V 확인
```

#### 6-2. GPIO 권한 설정

```bash
# 사용자를 gpio 그룹에 추가
sudo usermod -a -G gpio $USER

# 재부팅 또는 로그아웃/로그인
sudo reboot
```

**확인:**
```bash
groups $USER | grep gpio
# "gpio"가 출력되면 OK
```

#### 6-3. SSR 하드웨어 연결

**연결 방법 (레벨 시프터 없이 직접 연결):**
```
Jetson Pin 7 (GPIO) ----직접---- SSR+ (DC+, IN+)
Jetson GND          ------------- SSR- (DC-, IN-)
```

**중요:** 대부분의 SSR은 3-32V DC 입력을 지원하므로 3.3V로 충분합니다.

**테스트:**
- 사람 카메라 앞에 2초간 서기 → 콘솔에 "제어 PC ON" 출력 확인
- SSR LED 켜짐 확인
- 실제 부하(히터 등) 작동 확인

**상세 트러블슈팅:** `TROUBLESHOOTING_GPIO.md` 참조

---

### 7단계: GMSL 카메라 설정 (10분) 🚨

#### 7-1. 핀 설정 (한 번만, 재부팅 필요)

```bash
sudo /opt/nvidia/jetson-io/jetson-io.py
```

**메뉴 선택:**
1. `Configure Jetson 24pin CSI Connector`
2. `Configure for compatible hardware`
3. `Jetson Sensing YUV GMSLx4` 선택
4. `Save pin changes`
5. `Save and reboot to reconfigure pins` (재부팅됨)

**재부팅 후 계속...**

---

#### 6-2. v4l-utils 설치

```bash
sudo apt update
sudo apt-get install -y v4l-utils
```

---

#### 6-3. 카메라 초기화 (자동화 스크립트) ✨

```bash
cd ~/jetson-food-ai
sudo ./init_gmsl_cameras.sh
```

**실행 내용:**
- 커널 모듈 로드 (max96712, sgx-yuv-gmsl2)
- 4개 카메라 모두 GMSL2/3G, 1920x1536으로 초기화
- /dev/video0,1,2,3 생성 확인

**확인:**
```bash
ls -l /dev/video*
# 출력: video0, video1, video2, video3
```

---

#### 7-4. 자동 실행 서비스 설치 (권장) ✨

```bash
cd ~/jetson-food-ai
sudo ./install_gmsl_autoload.sh
```

**설치 내용:**
- gmsl-driver-load.service 생성
- 재부팅 시 `init_gmsl_cameras.sh` 자동 실행
- 커널 모듈 로드 + 4개 카메라 1920x1536 초기화 자동화

**이제 재부팅 시 수동 실행 불필요!** 🎉

---

### 8단계: 자동 실행 설정 (5분) ✨

```bash
cd ~/jetson-food-ai
sudo ./install_autostart.sh
```

**선택 화면:**
```
어떤 Jetson 시스템을 설치하시겠습니까?
1) Jetson #1 (볶음 모니터링 - JETSON1_INTEGRATED.py)
2) Jetson #2 (튀김 AI - JETSON2_INTEGRATED.py)
선택 (1 또는 2):
```

**실행 순서 (자동):**
```
부팅 → 자동 로그인
  ↓
1. GMSL 카메라 초기화 (gmsl-driver-load.service, root)
   → 커널 모듈 로드 (max96712, sgx-yuv-gmsl2)
   → 4개 카메라 1920x1536 설정 (v4l2-ctl)
   → /dev/video0,1,2,3 생성 및 준비 완료
  ↓
2. 5초 대기
  ↓
3. Python 프로그램 실행 (일반 유저 권한)
   → jetson1-monitor.service (또는 jetson2-monitor.service)
   → PYTHONPATH 자동 설정 (~/.local/lib/python3.10/site-packages)
   → GUI 화면 표시
```

**중요:** 일반 유저 권한으로 실행되므로 pip3로 설치한 패키지를 정상적으로 사용할 수 있습니다.

**확인:**
```bash
# Jetson1
sudo systemctl status jetson1-monitor

# Jetson2
sudo systemctl status jetson2-monitor
```

---

### 9단계: MQTT 설정 🚨 **필수!**

#### 9-1. 이더넷 고정 IP 설정 (처음 한 번만)

**MQTT 브로커는 이더넷으로 연결됩니다** (WiFi 아님!)

**GUI에서 설정 (추천):**

1. 화면 우측 상단 네트워크 아이콘 클릭
2. **Wired Settings** (유선 설정) 클릭
3. 톱니바퀴 아이콘 ⚙️ 클릭
4. **IPv4** 탭 선택
5. **IPv4 Method**: `Manual` 선택
6. **Addresses** 입력:
   - **Address**: `192.168.0.100` (또는 로봇 PC와 같은 네트워크)
   - **Netmask**: `255.255.255.0`
   - **Gateway**: `192.168.0.1` (라우터 IP)
7. **Apply** 클릭
8. 네트워크 재연결 (이더넷 케이블 뽑았다 꽂기 또는 재부팅)

**명령어로 설정 (대안):**
```bash
# 연결 이름 확인
nmcli connection show

# 고정 IP 설정 (연결 이름이 "Wired connection 1"인 경우)
sudo nmcli connection modify "Wired connection 1" ipv4.method manual
sudo nmcli connection modify "Wired connection 1" ipv4.addresses 192.168.0.100/24
sudo nmcli connection modify "Wired connection 1" ipv4.gateway 192.168.0.1
sudo nmcli connection modify "Wired connection 1" ipv4.dns "8.8.8.8"
sudo nmcli connection up "Wired connection 1"

# 확인
ip addr show
# eth0에 192.168.0.100이 보여야 함
```

**연결 테스트:**
```bash
# 로봇 PC와 통신 확인 (로봇 PC IP가 192.168.0.14인 경우)
ping -c 3 192.168.0.14
```

성공하면 계속 진행하세요!

---

#### 9-2. MQTT Config 설정

**로봇 PC의 MQTT Broker IP 주소 확인 후:**

#### Jetson1 설정
```bash
nano ~/jetson-food-ai/jetson1_monitoring/config.json
```

변경:
```json
{
  "mqtt_enabled": true,
  "mqtt_broker": "192.168.x.x",
  "mqtt_port": 1883,
  "mqtt_topic": "robot/control",
  "mqtt_topic_ai_mode": "jetson1/system/ai_mode",
  "ai_mode_enabled": false
}
```

#### Jetson2 설정
```bash
nano ~/jetson-food-ai/jetson2_frying_ai/config_jetson2.json
```

변경:
```json
{
  "mqtt_enabled": true,
  "mqtt_broker": "192.168.x.x",
  "mqtt_port": 1883,
  "mqtt_topic_frying": "frying/status",
  "mqtt_topic_observe": "observe/status",
  "mqtt_topic_ai_mode": "jetson2/system/ai_mode",
  "ai_mode_enabled": false
}
```

**저장:** `Ctrl+O` → `Enter` → `Ctrl+X`

#### AI 모드 설정 (`ai_mode_enabled`)

**이 설정은 AI가 완성되어 사용 가능한지 여부를 나타냅니다:**
- `false` (기본값): AI 미완성 - 개발/테스트 단계
- `true`: AI 완성됨 - 운영/배포 단계

**이 값은 MQTT 연결 시 한 번만 발행됩니다:**
- Jetson1: `jetson1/system/ai_mode` 토픽으로 "ON" 또는 "OFF"
- Jetson2: `jetson2/system/ai_mode` 토픽으로 "ON" 또는 "OFF"

**사용 예시:**
```bash
# AI 개발 중 (기본값)
"ai_mode_enabled": false  # → MQTT로 "OFF" 발행

# AI 완성 후 (배포 준비 완료)
"ai_mode_enabled": true   # → MQTT로 "ON" 발행
```

**주의:** 이 설정은 AI 시작/중지 버튼과 무관하며, 로봇 PC에게 "이 Jetson에 AI가 장착되었는지"를 알려주는 용도입니다.

---

### 10단계: 재부팅 및 테스트

```bash
sudo reboot
```

**재부팅 후 자동으로:**
1. GMSL 카메라 초기화 (모듈 로드 + 카메라 설정)
2. Python 프로그램 실행
3. GUI 창 표시

**확인 사항:**
- ✅ GUI 창에서 카메라 영상 표시
- ✅ 콘솔에 "[MQTT] 연결 성공" 메시지
- ✅ 로봇 PC MQTT Broker에 연결됨

---

## 📡 MQTT 통신 확인

### Jetson → 로봇 PC 메시지

**Jetson1 (볶음 모니터링):**
- **사람 감지**: `frying_ai/jetson1/robot/control`
  ```json
  {
    "command": "ON",
    "source": "auto_start_system",
    "person_detected": true
  }
  ```

- **AI 모드**: `jetson1/system/ai_mode`
  ```json
  {
    "device_id": "jetson1",
    "device_name": "Jetson1_StirFry_Station",
    "message": "ON",
    "timestamp": "2025-11-10 17:00:00"
  }
  ```

**Jetson2 (튀김 AI):**
- **바구니 상태**: `jetson2/observe/status`
  ```json
  {
    "device_id": "jetson2",
    "message": "LEFT:BASKET_IN",
    "timestamp": "2025-11-10 17:00:00"
  }
  ```

- **AI 모드**: `jetson2/system/ai_mode`
  ```json
  {
    "device_id": "jetson2",
    "message": "ON",
    "timestamp": "2025-11-10 17:00:00"
  }
  ```

### 로봇 PC → Jetson 메시지

**Jetson2가 수신:**
- `frying/oil_temp/left` - 왼쪽 기름 온도
- `frying/probe_temp/left` - 왼쪽 탐침 온도
- `frying/food_type` - 음식 종류

### 로봇팀 구독 방법

```python
# 모든 Jetson AI 모드 받기 (wildcard)
mqtt_client.subscribe("+/system/ai_mode")

# Jetson2 바구니 상태 받기
mqtt_client.subscribe("jetson2/observe/status")

# Jetson1 사람 감지 받기
mqtt_client.subscribe("frying_ai/jetson1/robot/control")
```

### 테스트 방법

**방법 1: Python 테스트 툴 (추천)**
```bash
cd ~/jetson-food-ai
python3 test_mqtt_publish.py

# 대화형으로 MQTT 메시지 발행 테스트
# 1. Broker IP 입력 (예: 192.168.0.14)
# 2. 메시지 타입 선택
# 3. 자동으로 올바른 형식의 JSON 발행
```

**방법 2: mosquitto_pub 사용**

**로봇 PC에서 (메시지 수신):**
```bash
# 모든 AI 모드 메시지 수신
mosquitto_sub -h localhost -t "+/system/ai_mode" -v

# Jetson2 바구니 상태 수신
mosquitto_sub -h localhost -t "jetson2/observe/status" -v

# 모든 메시지 수신 (디버깅)
mosquitto_sub -h localhost -t "#" -v
```

**Jetson에서 (메시지 발행):**
```bash
# AI 모드 테스트
mosquitto_pub -h 192.168.0.14 -t "jetson2/system/ai_mode" \
  -m '{"device_id":"jetson2","message":"ON","timestamp":"2025-11-10 21:00:00"}'

# 바구니 상태 테스트
mosquitto_pub -h 192.168.0.14 -t "jetson2/observe/status" \
  -m '{"device_id":"jetson2","message":"LEFT:BASKET_IN","timestamp":"2025-11-10 21:00:00"}'
```

---

## 🛠️ 서비스 관리

### 상태 확인
```bash
# GMSL 드라이버
sudo systemctl status gmsl-driver-load

# Python 프로그램
sudo systemctl status jetson1-monitor  # Jetson1
sudo systemctl status jetson2-monitor  # Jetson2
```

### 로그 확인

**실시간 로그 보기 (가장 유용!) ⭐**
```bash
# Python 프로그램 실시간 모니터링 (터미널처럼 print 출력 보임)
sudo journalctl -u jetson2-monitor -f  # Jetson2
sudo journalctl -u jetson1-monitor -f  # Jetson1

# 종료: Ctrl+C
```
💡 **팁**: 새 터미널 열어서 `-f` 옵션으로 띄워놓고 개발하면 매우 편리합니다!

**최근 로그만 확인**
```bash
# 최근 100줄
sudo journalctl -u jetson2-monitor -n 100

# 최근 200줄 (더 많이 보기)
sudo journalctl -u jetson2-monitor -n 200

# 페이지 없이 한번에 출력
sudo journalctl -u jetson2-monitor -n 100 --no-pager
```

**GMSL 드라이버 로그**
```bash
cat /tmp/gmsl_driver_load.log
```

### 자동 실행 디버깅 방법

**서비스 실패 시 로그 확인:**
```bash
# 최근 100줄 로그 확인
sudo journalctl -u jetson2-monitor -n 100 --no-pager

# 실시간 로그 모니터링 (새 터미널에서)
sudo journalctl -u jetson2-monitor -f

# 오류만 필터링해서 보기
sudo journalctl -u jetson2-monitor -p err -n 50
```

**서비스 상태 상세 확인:**
```bash
# 상태 및 최근 로그 함께 보기
sudo systemctl status jetson2-monitor

# 서비스 재시작 후 즉시 로그 확인
sudo systemctl restart jetson2-monitor && sudo journalctl -u jetson2-monitor -f
```

**서비스 설정 확인:**
```bash
# User 확인 (일반 유저여야 함, root이면 안됨)
sudo cat /etc/systemd/system/jetson2-monitor.service | grep "User="

# PYTHONPATH 확인 (pip --user로 설치한 경우 필요)
sudo cat /etc/systemd/system/jetson2-monitor.service | grep "PYTHONPATH"

# 전체 서비스 파일 확인
sudo cat /etc/systemd/system/jetson2-monitor.service
```

**자주 발생하는 오류와 해결 방법:**

1. **ModuleNotFoundError: No module named 'ultralytics'**
   ```bash
   # 원인: 서비스가 root로 실행되거나 PYTHONPATH가 설정되지 않음
   # 해결: install_autostart.sh 스크립트 재실행
   cd ~/jetson-food-ai
   sudo ./uninstall_autostart.sh
   ./install_autostart.sh
   ```

2. **Permission denied (카메라 접근 오류)**
   ```bash
   # 원인: 유저가 video 그룹에 속하지 않음
   # 해결: 유저를 video 그룹에 추가
   sudo usermod -a -G video $USER
   sudo usermod -a -G dialout $USER
   # 재부팅 또는 재로그인 필요
   ```

3. **GMSL 드라이버 로드 실패**
   ```bash
   # GMSL 드라이버 로그 확인
   cat /tmp/gmsl_driver_load.log

   # 드라이버 수동 로드 테스트
   cd ~/jetson-camera-monitor/SG4A-NONX-G2Y-A1_ORIN_NANO_YUV_JP6.2_L4TR36.4.3
   sudo ./quick_bring_up.sh

   # Python 서비스는 GMSL 드라이버가 먼저 로드되어야 함
   # gmsl-driver-load.service가 먼저 성공해야 함
   sudo systemctl status gmsl-driver-load
   ```

4. **MQTT 연결 실패**
   ```bash
   # Mosquitto broker 상태 확인
   sudo systemctl status mosquitto

   # MQTT 포트 확인 (1883이 열려있어야 함)
   netstat -an | grep 1883

   # config 파일에서 broker 주소 확인
   cat ~/jetson-food-ai/jetson2_frying_ai/config_jetson2.json | grep mqtt
   ```

### 수동 실행 (테스트용)
```bash
# 자동 실행 중지
sudo systemctl stop jetson1-monitor

# 수동 실행
cd ~/jetson-food-ai/jetson1_monitoring
python3 JETSON1_INTEGRATED.py
```

### 자동 실행 제거
```bash
cd ~/jetson-food-ai
sudo ./uninstall_autostart.sh
```

---

## 🔧 문제 해결

### 1. GPU가 사용되지 않음 (CUDA Available: False)

**증상:**
```
[GPU] PyTorch CUDA 미지원
CUDA Available: False
```

**원인:** CPU 버전 torch가 설치되었거나, 캐시 문제

**해결:**
```bash
# 1. 현재 torch 확인
python3 -c "import torch; print(torch.__version__); print(torch.cuda.is_available())"

# 2. 완전히 제거
pip3 uninstall -y torch torchvision
rm -rf ~/.local/lib/python3.10/site-packages/torch*
rm -rf ~/.cache/pip

# 3. Jetson용 CUDA 버전 재설치
pip3 install torch torchvision --index-url https://pypi.jetson-ai-lab.io/jp6/cu126

# 4. 확인
python3 -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}')"
# PyTorch: 2.9.0
# CUDA: True 나와야 함!
```

---

### 2. NumPy 버전 충돌

**증상:**
```
AttributeError: _ARRAY_API not found
A module that was compiled using NumPy 1.x cannot be run in NumPy 2.x
```

**원인:** NumPy 2.x가 설치되었는데 시스템 matplotlib이 NumPy 1.x용

**해결:**
```bash
# NumPy 1.x로 다운그레이드
pip3 install 'numpy>=1.21.0,<2.0.0' --force-reinstall

# 확인
python3 -c "import numpy; print(numpy.__version__)"
# 1.x.x 나와야 함
```

---

### 3. 카메라가 안 보임 / 안 떠

**증상 1: video 장치 자체가 없음**
```bash
ls -l /dev/video*
# No such file or directory
```

**해결:**
```bash
# 1. jetson-io로 핀 설정 확인 (한 번만)
sudo /opt/nvidia/jetson-io/jetson-io.py
# Jetson Sensing YUV GMSLx4 선택되어 있는지 확인

# 2. 카메라 초기화
cd ~/jetson-food-ai
sudo ./init_gmsl_cameras.sh

# 3. 확인
ls -l /dev/video*
```

---

**증상 2: video 장치는 있는데 프로그램에서 카메라 안 뜸**

**원인:** 카메라 초기화 안 됨

**해결:**
```bash
cd ~/jetson-food-ai
sudo ./init_gmsl_cameras.sh
```

**이 스크립트가 하는 일:**
- 커널 모듈 로드
- 4개 카메라 GMSL2/3G, 1920x1536으로 초기화
- v4l2-ctl로 각 카메라 설정

---

### 4. MQTT 연결 안 됨

**증상:**
```
[MQTT] 연결 실패
```

**확인 사항:**
1. 로봇 PC MQTT Broker 실행 중인지 확인
2. config.json의 IP 주소 정확한지 확인
3. 네트워크 연결 확인

```bash
# 로봇 PC에 ping 테스트
ping <로봇PC_IP>

# MQTT 포트 확인
nc -zv <로봇PC_IP> 1883
```

**config.json 재확인:**
```bash
nano ~/jetson-food-ai/jetson1_monitoring/config.json
# mqtt_enabled: true
# mqtt_broker: 올바른 IP
```

---

### 5. ModuleNotFoundError: No module named 'ultralytics'

**증상:**
```
ModuleNotFoundError: No module named 'ultralytics'
ModuleNotFoundError: No module named 'paho'
```

**원인:** 서비스가 일반 유저가 아닌 root로 실행되고 있음

**해결:**
```bash
# 1. 서비스 재설치 (일반 유저 권한으로)
cd ~/jetson-food-ai
sudo ./uninstall_autostart.sh
sudo ./install_autostart.sh
# 1 또는 2 선택

# 2. 서비스 파일 확인
sudo cat /etc/systemd/system/jetson2-monitor.service | grep User
# User=hr_dku_002 (일반 유저여야 함)

# 3. PYTHONPATH 확인
sudo cat /etc/systemd/system/jetson2-monitor.service | grep PYTHONPATH
# Environment="PYTHONPATH=/home/hr_dku_002/.local/lib/python3.10/site-packages"

# 4. 재시작
sudo systemctl daemon-reload
sudo systemctl restart jetson2-monitor
```

---

### 6. 자동 실행 안 됨 (서비스 FAILURE)

**증상:**
```
Active: activating (auto-restart) (Result: exit-code)
Process: ExecStart=... (code=exited, status=1/FAILURE)
```

**확인 순서:**
```bash
# 1. 로그 확인 (가장 중요!)
sudo journalctl -u jetson2-monitor -n 50 --no-pager

# 2. 카메라 초기화 확인
ls -l /dev/video*
# video0~3 있어야 함

# 3. 수동 실행 테스트
cd ~/jetson-food-ai/jetson2_frying_ai
python3 JETSON2_INTEGRATED.py
# 어떤 에러가 나는지 확인

# 4. 카메라 재초기화
sudo ~/jetson-food-ai/init_gmsl_cameras.sh

# 5. 서비스 재시작
sudo systemctl restart jetson2-monitor
sudo systemctl status jetson2-monitor
```

---

### 7. 카메라 초기화 후 화면이 이상함

**증상:** video 장치는 있는데 초록 화면 또는 검은 화면

**원인:** 카메라 스트림이 제대로 시작 안 됨

**해결:**
```bash
# 방법 1: init_gmsl_cameras.sh 재실행 (clock_config 포함)
sudo ~/jetson-food-ai/init_gmsl_cameras.sh

# 방법 2: 재부팅 (가장 확실)
sudo reboot
```

---

### 8. GUI 창 종료 버튼이 안 보임

**원인:** 전체화면 모드이거나 window_decorations가 false

**해결:**

**방법 1 - 키보드 단축키 사용:**
- `F11` 키: 전체화면 토글
- `ESC` 키: 전체화면 해제 (창모드로)

**방법 2 - config.json 수정:**
```bash
nano ~/jetson-food-ai/jetson2_frying_ai/config_jetson2.json
# "window_decorations": true 로 변경
# "fullscreen": false 로 변경
```

---

### 9. GUI 창이 안 뜸

**해결:**
```bash
export DISPLAY=:0
xhost +local:
cd ~/jetson-food-ai/jetson1_monitoring
python3 JETSON1_INTEGRATED.py
```

---

## 📊 최종 설치 체크리스트

### 파일 및 설정
- [ ] `jetson-food-ai.tar.gz` USB에서 복사 완료
- [ ] 압축 해제 완료
- [ ] **팝업 비활성화 완료 (disable_popups.sh 실행)** 🚨
- [ ] **자동 로그인 설정 완료** 🚨
- [ ] 한글 폰트 설치 완료
- [ ] CH340 드라이버 설치 완료 (선택)
- [ ] **pip3 설치 완료** 🚨
- [ ] Python 패키지 설치 완료 (requirements.txt 2개)
- [ ] **NumPy 1.x 강제 설치** 🚨
- [ ] **PyTorch CUDA 설치 확인** 🚨

### 시스템 설정
- [ ] MAXN 성능 모드 활성화
- [ ] **GPIO 설정 완료 (Jetson1만)** 🚨
  - [ ] Device Tree Overlay 설정
  - [ ] GPIO 권한 설정 (gpio 그룹)
  - [ ] SSR 하드웨어 연결
  - [ ] GPIO 테스트 (3.3V 확인)
- [ ] GMSL 드라이버 파일 설치
- [ ] GMSL 자동 로드 서비스 설치
- [ ] **Python 자동 실행 서비스 설치 (일반 유저 권한)** 🚨
- [ ] **MQTT 설정 완료 (broker IP)** 🚨

### 테스트
- [ ] 재부팅 후 자동 실행 확인
- [ ] 팝업 없이 정상 동작 확인
- [ ] 카메라 영상 표시 확인 (`/dev/video*`)
- [ ] GPU 사용 확인 (CUDA Available: True)
- [ ] **SSR 제어 테스트 (Jetson1만)** 🚨
  - [ ] 사람 2초 감지 → "제어 PC ON" 출력
  - [ ] SSR LED 켜짐 확인
  - [ ] 실제 부하 작동 확인
- [ ] MQTT 연결 확인
- [ ] 로봇 PC에서 메시지 수신 확인

---

## 🎯 주요 파일 위치

### Jetson #1 (볶음 모니터링)

**프로그램:**
- 메인: `~/jetson-food-ai/jetson1_monitoring/JETSON1_INTEGRATED.py`
- 설정: `~/jetson-food-ai/jetson1_monitoring/config.json`
- 패키지: `~/jetson-food-ai/jetson1_monitoring/requirements.txt`

**데이터 저장:**
- 스냅샷: `~/Detection/YYYYMMDD/HHMMSS.jpg`
- 볶음 데이터: `~/StirFry_Data/left/`, `~/StirFry_Data/right/`

**서비스:**
- GMSL 드라이버: `gmsl-driver-load.service`
- 자동 실행: `jetson1-monitor.service`

### Jetson #2 (튀김 AI)

**프로그램:**
- 메인: `~/jetson-food-ai/jetson2_frying_ai/JETSON2_INTEGRATED.py`
- 설정: `~/jetson-food-ai/jetson2_frying_ai/config_jetson2.json`
- 패키지: `~/jetson-food-ai/jetson2_frying_ai/requirements.txt`

**데이터 저장:**
- 튀김 데이터: `~/AI_Data/FryingData/`
- 바켓 데이터: `~/AI_Data/BucketData/`

**서비스:**
- GMSL 드라이버: `gmsl-driver-load.service`
- 자동 실행: `jetson2-monitor.service`

---

## 📞 빠른 설치 요약

### 0. 팝업 비활성화 및 자동 로그인 ⚠️
```bash
# 팝업 비활성화
cd ~/jetson-food-ai
./disable_popups.sh

# 자동 로그인 설정
sudo nano /etc/gdm3/custom.conf
# AutomaticLoginEnable = true
# AutomaticLogin = hr_dku_002  (실제 사용자 이름)

# 재부팅
sudo reboot
```

### 1. USB에서 복사
```bash
cp /media/usb/jetson-food-ai.tar.gz ~/
tar -xzf jetson-food-ai.tar.gz
cd jetson-food-ai
```

### 2. 설치 (WiFi 필요)
```bash
# 한글 폰트
sudo ./install_korean_fonts.sh

# pip3 설치 (필수!)
sudo apt update
sudo apt install -y python3-pip

# Python 패키지
pip3 install -r jetson1_monitoring/requirements.txt  # 또는 jetson2

# NumPy 1.x 강제 설치
pip3 install 'numpy>=1.21.0,<2.0.0' --force-reinstall

# PyTorch CUDA (기존 것 제거 후 설치)
pip3 uninstall -y torch torchvision
pip3 install torch torchvision --index-url https://pypi.jetson-ai-lab.io/jp6/cu126

# MAXN 모드
sudo ./set_maxn_mode.sh
sudo ./install_maxn_service.sh
```

### 3. GPIO 설정 (Jetson1만) 🚨
```bash
cd ~/jetson-food-ai/jetson-orin-gpio-patch
sudo cp pin7_as_gpio.dtbo /boot/
sudo /opt/nvidia/jetson-io/jetson-io.py
# Configure Jetson 40pin Header → Pin 7 gpio bidirectional
# Save and reboot

# GPIO 권한 설정
sudo usermod -a -G gpio $USER
sudo reboot

# 테스트
python3 gpio_test.py
```

### 4. GMSL 카메라 설정
```bash
# 핀 설정 (한 번만, 재부팅 필요)
sudo /opt/nvidia/jetson-io/jetson-io.py
# Configure Jetson 24pin CSI → Jetson Sensing YUV GMSLx4
# Save and reboot

# 재부팅 후
sudo apt-get install -y v4l-utils
sudo ./init_gmsl_cameras.sh

# 확인
ls -l /dev/video*

# 카메라 자동 초기화 서비스 설치 (권장)
sudo ./install_gmsl_autoload.sh

# Python 프로그램 자동 실행 설정
sudo ./install_autostart.sh  # 1 또는 2 선택
```

### 5. MQTT 설정 🚨
```bash
nano jetson1_monitoring/config.json  # 또는 jetson2
# mqtt_enabled: true
# mqtt_broker: 로봇 PC IP
```

### 6. 재부팅
```bash
sudo reboot
```

---

## ✅ 핵심 포인트

### 반드시 해야 할 것 🚨
1. **팝업 비활성화** - disable_popups.sh 실행 후 재부팅
2. **GPIO 설정 (Jetson1만)** - Device Tree Overlay + 권한 설정
3. **MQTT broker IP 설정** - 로봇 PC IP 확인 후 config.json 수정
4. **PyTorch CUDA 설치** - GPU 가속 필수
5. **자동 로드/실행 설정** - 재부팅 시 자동 동작

### WiFi가 필요한 작업
- Python 패키지 설치 (requirements.txt)
- PyTorch CUDA 설치
- YOLO 모델 자동 다운로드 (첫 실행 시)

### WiFi 없이 동작
- 설치 완료 후 완전 오프라인 동작
- MQTT는 로컬 네트워크 (로봇 PC와 통신)
- 재부팅 시 자동 실행

---

**이 문서 하나면 배포 끝!** 🚀

**문제 발생 시:**
1. 로그 확인: `sudo journalctl -u jetson1-monitor -f`
2. 서비스 상태: `sudo systemctl status jetson1-monitor`
3. GMSL 드라이버: `cat /tmp/gmsl_driver_load.log`
