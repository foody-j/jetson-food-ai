# Jetson Orin #1 - Monitoring System with GMSL Camera Support
services:
  # Production monitoring service
  jetson-monitor:
    image: jetson-monitor:latest
    container_name: jetson1-monitoring
    build:
      context: .
      dockerfile: Dockerfile

    # IMPORTANT: Privileged mode required for GMSL drivers (insmod in container)
    privileged: true

    # Interactive terminal (for debugging)
    stdin_open: true
    tty: true

    # Security capabilities for kernel module loading
    cap_add:
      - SYS_MODULE      # Required for insmod/rmmod
      - SYS_ADMIN       # Required for /sys/kernel/debug access
      - SYS_RAWIO       # Required for device access

    # Environment variables
    environment:
      - TZ=Asia/Seoul
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=/tmp/.docker.xauth
      - QT_X11_NO_MITSHM=1
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

    # Volume mounts
    volumes:
      # Application code (mount host directory for live updates)
      - ./autostart_autodown:/app/autostart_autodown
      - ./src:/app/src
      - ./camera_autostart:/app/camera_autostart
      - ./SG4A-NONX-G2Y-A1_ORIN_NANO_YUV_JP6.2_L4TR36.4.3:/app/SG4A-NONX-G2Y-A1_ORIN_NANO_YUV_JP6.2_L4TR36.4.3

      # Data persistence (recordings & snapshots)
      - ./autostart_autodown/Detection:/app/autostart_autodown/Detection
      - ./autostart_autodown/StirFry_Data:/app/autostart_autodown/StirFry_Data

      # X11 socket for GUI display
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Mount Docker xauth file created by setup_x11.sh
      - /tmp/.docker.xauth:/tmp/.docker.xauth:ro

      # Custom entrypoint script with X11 fixes
      - ./docker-entrypoint.sh:/entrypoint.sh:ro

      # Kernel modules for GMSL driver loading (CRITICAL for insmod in container)
      - /lib/modules:/lib/modules:ro
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /usr/src:/usr/src:ro

      # Full device access for cameras
      - /dev:/dev

    # GMSL Camera devices
    devices:
      # GPU devices
      - /dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu
      - /dev/nvmap:/dev/nvmap
      - /dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu
      - /dev/nvhost-gpu:/dev/nvhost-gpu
      - /dev/nvhost-as-gpu:/dev/nvhost-as-gpu
      # GMSL Cameras (CN4, CN5, CN6, CN7)
      - /dev/video0:/dev/video0  # Human surveillance (CN4)
      - /dev/video1:/dev/video1  # Stir-fry LEFT (CN5)
      - /dev/video2:/dev/video2  # Stir-fry RIGHT (CN6)
      - /dev/video3:/dev/video3  # Unused (CN7)

    # Group permissions
    group_add:
      - video

    # Network mode: host for MQTT and X11
    network_mode: host

    # IPC mode: host for shared memory
    ipc: host

    # NVIDIA runtime for GPU access
    runtime: nvidia

    # Restart policy (change to 'always' for production)
    restart: unless-stopped

  # Development container (optional - comment out for production)
  ai-dev:
    image: jp6:jp6
    container_name: my-dev-container
    build:
      context: .
      dockerfile: Dockerfile
    stdin_open: true
    tty: true
    environment:
      - TZ=Asia/Seoul
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
    volumes:
      - .:/project
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    devices:
      - /dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu
      - /dev/nvmap:/dev/nvmap
      - /dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu
      - /dev/nvhost-gpu:/dev/nvhost-gpu
      - /dev/nvhost-as-gpu:/dev/nvhost-as-gpu
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/video2:/dev/video2
      - /dev/video3:/dev/video3
    privileged: true
    group_add:
      - video
    network_mode: host
    runtime: nvidia
    ipc: host
    restart: 'no'
    # Override entrypoint for interactive shell
    entrypoint: ["/bin/bash"]